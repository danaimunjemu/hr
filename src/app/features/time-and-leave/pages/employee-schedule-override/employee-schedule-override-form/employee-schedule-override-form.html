<nz-page-header
  [nzGhost]="false"
  [nzBackIcon]="'arrow-left'"
  (nzBack)="onCancel()"
  [nzTitle]="isEditMode() ? 'Edit Employee Schedule Override' : 'New Employee Schedule Override'"
>
</nz-page-header>

<nz-card [nzLoading]="loading()">
  <form nz-form [formGroup]="form" (ngSubmit)="onSubmit()" nzLayout="vertical">
    
    <div nz-row [nzGutter]="24">
      <div nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="24" nzRequired nzFor="employee">Employee</nz-form-label>
          <nz-form-control [nzSpan]="24" nzErrorTip="Please select an employee">
            <nz-select formControlName="employee" [compareWith]="compareFn" nzPlaceHolder="Select an employee" nzShowSearch>
              <nz-option *ngFor="let emp of employees()" [nzValue]="emp" [nzLabel]="emp.firstName + ' ' + emp.lastName"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="24" nzRequired nzFor="rotationType">Rotation Type</nz-form-label>
          <nz-form-control [nzSpan]="24" nzErrorTip="Required">
            <nz-select formControlName="rotationType">
              <nz-option nzValue="FIXED" nzLabel="Fixed Shift"></nz-option>
              <nz-option nzValue="ROTATING" nzLabel="Rotating Shift"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>

    <div nz-row [nzGutter]="24">
      <div nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="24" nzRequired nzFor="effectiveFrom">Effective From</nz-form-label>
          <nz-form-control [nzSpan]="24" nzErrorTip="Required">
            <nz-date-picker formControlName="effectiveFrom" style="width: 100%"></nz-date-picker>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="24" nzRequired nzFor="cycleStartDate">Cycle Start Date</nz-form-label>
          <nz-form-control [nzSpan]="24" nzErrorTip="Required">
            <nz-date-picker formControlName="cycleStartDate" style="width: 100%"></nz-date-picker>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>

    <div nz-row [nzGutter]="24">
      <div nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="24" nzRequired nzFor="cycleOnWeeks">Cycle On Weeks</nz-form-label>
          <nz-form-control [nzSpan]="24" nzErrorTip="Must be >= 1">
            <nz-input-number formControlName="cycleOnWeeks" [nzMin]="1" [nzStep]="1" style="width: 100%"></nz-input-number>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col [nzSpan]="12">
        <nz-form-item>
          <nz-form-label [nzSpan]="24" nzRequired nzFor="cycleOffWeeks">Cycle Off Weeks</nz-form-label>
          <nz-form-control [nzSpan]="24" nzErrorTip="Must be >= 0">
            <nz-input-number formControlName="cycleOffWeeks" [nzMin]="0" [nzStep]="1" style="width: 100%"></nz-input-number>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>

    <nz-divider></nz-divider>

    <!-- FIXED TYPE -->
    <div *ngIf="form.get('rotationType')?.value === 'FIXED'">
      <nz-form-item>
        <nz-form-label [nzSpan]="24" nzRequired nzFor="shiftDefinition">Shift Definition</nz-form-label>
        <nz-form-control [nzSpan]="24" nzErrorTip="Please select a shift">
          <nz-select formControlName="shiftDefinition" [compareWith]="compareFn" nzPlaceHolder="Select a shift">
            <nz-option *ngFor="let shift of shiftDefinitions()" [nzValue]="shift" [nzLabel]="shift.name"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>
    </div>

    <!-- ROTATING TYPE -->
    <div *ngIf="form.get('rotationType')?.value === 'ROTATING'">
      <div class="mb-4 flex justify-between items-center">
        <h4 class="text-base font-medium">Rotation Shifts</h4>
        <button nz-button type="button" (click)="addRotationShift()">Add Shift</button>
      </div>
      
      <div formArrayName="rotationShifts">
        <div *ngFor="let shift of rotationShifts.controls; let i=index" [formGroupName]="i" class="rotation-shift-item">
          <div style="flex: 0 0 50px; text-align: center;">
            <span class="font-bold">#{{ i + 1 }}</span>
          </div>
          <div style="flex: 1;">
            <nz-form-item style="margin-bottom: 0;">
              <nz-form-control [nzSpan]="24" nzErrorTip="Required">
                <nz-select formControlName="shiftDefinition" [compareWith]="compareFn" nzPlaceHolder="Select shift">
                  <nz-option *ngFor="let s of shiftDefinitions()" [nzValue]="s" [nzLabel]="s.name"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>
          <button nz-button type="button" nzDanger nzShape="circle" (click)="removeRotationShift(i)">
            <span nz-icon nzType="delete"></span>
          </button>
        </div>
      </div>
    </div>

    <div class="flex justify-end gap-4 mt-6">
      <button nz-button type="button" (click)="onCancel()">Cancel</button>
      <button nz-button nzType="primary" [nzLoading]="submitting()">
        {{ isEditMode() ? 'Update' : 'Create' }}
      </button>
    </div>
  </form>
</nz-card>
