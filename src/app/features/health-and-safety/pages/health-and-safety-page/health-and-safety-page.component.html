<nz-page-header nzTitle="Health & Safety">
  <nz-page-header-extra>
    <button nz-button (click)="loadData()">
      <span nz-icon nzType="reload"></span>
      Refresh
    </button>
    <button nz-button nzType="primary" nzDanger routerLink="../incidents/create">Report Incident</button>
  </nz-page-header-extra>
</nz-page-header>

<div class="page-content">
  <!-- Loading & Error States -->
  <div *ngIf="loading()" class="loading-container">
    <nz-spin nzSimple></nz-spin>
  </div>

  <div *ngIf="error()" class="error-container">
    <nz-alert nzType="error" [nzMessage]="error()" nzShowIcon></nz-alert>
  </div>

  <div *ngIf="!loading() && !error()">
    <!-- Overview Stats -->
    <div nz-row [nzGutter]="16" class="stats-row">
      <div nz-col [nzSpan]="6">
        <nz-card>
          <nz-statistic [nzValue]="incidents().length" [nzTitle]="'Safety Incidents'" [nzPrefix]="prefixSafe"></nz-statistic>
          <ng-template #prefixSafe><span nz-icon nzType="check-circle" nzTheme="twotone" [nzTwotoneColor]="'#52c41a'"></span></ng-template>
        </nz-card>
      </div>
      <div nz-col [nzSpan]="6">
        <nz-card>
          <nz-statistic [nzValue]="nearMisses().length" [nzTitle]="'Near Misses'" [nzPrefix]="prefixWarn"></nz-statistic>
          <ng-template #prefixWarn><span nz-icon nzType="warning" nzTheme="twotone" [nzTwotoneColor]="'#faad14'"></span></ng-template>
        </nz-card>
      </div>
      <div nz-col [nzSpan]="6">
        <nz-card>
          <nz-statistic [nzValue]="medicalSurveillances().length" [nzTitle]="'Medical Surveillance'" [nzPrefix]="prefixMedical"></nz-statistic>
          <ng-template #prefixMedical><span nz-icon nzType="medicine-box" nzTheme="twotone" [nzTwotoneColor]="'#13c2c2'"></span></ng-template>
        </nz-card>
      </div>
      <div nz-col [nzSpan]="6">
        <nz-card>
          <nz-statistic [nzValue]="getTotalReports()" [nzTitle]="'Total Reports'" [nzSuffix]="'records'"></nz-statistic>
        </nz-card>
      </div>
    </div>

    <div nz-row [nzGutter]="16" class="content-card">
      <div nz-col [nzSpan]="16">
        <nz-card nzTitle="Reported Trend (Last 6 Months)">
          <div #trendChartContainer class="chart-host"></div>
        </nz-card>
      </div>
      <div nz-col [nzSpan]="8">
        <nz-card nzTitle="Report Distribution">
          <div #distributionChartContainer class="chart-host"></div>
          <div class="mt-4 text-sm text-gray-500">
            <div>Open Items: <strong>{{ getOpenItemsCount() }}</strong></div>
            <div>Submitted Pending Review: <strong>{{ getSubmittedItemsCount() }}</strong></div>
          </div>
        </nz-card>
      </div>
    </div>

    <nz-card nzTitle="Operational Records" class="content-card">
      <div class="mb-4">
        <nz-segmented
          [ngModel]="activeTab()"
          (ngModelChange)="activeTab.set($event)"
          [nzOptions]="tabOptions">
        </nz-segmented>
      </div>

      <nz-table *ngIf="activeTab() === 'incidents'" #incidentTable [nzData]="incidents()" [nzPageSize]="8">
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Location</th>
            <th>Reported By</th>
            <th>Severity</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let data of incidentTable.data">
            <td>{{ data.incidentDateTime | date:'mediumDate' }}</td>
            <td>{{ data.description || data.injuryDetails || '-' }}</td>
            <td>{{ data.location }}</td>
            <td>{{ getReporterName(data.reportedBy) }}</td>
            <td><nz-tag [nzColor]="getSeverityColor(data.severity)">{{ data.severity }}</nz-tag></td>
            <td><nz-tag [nzColor]="getStatusColor(data.status)">{{ data.status }}</nz-tag></td>
            <td>
              <a [routerLink]="['../incidents/view', data.id]">View</a>
            </td>
          </tr>
        </tbody>
      </nz-table>

      <nz-table *ngIf="activeTab() === 'nearMisses'" #nearMissTable [nzData]="nearMisses()" [nzPageSize]="8">
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Location</th>
            <th>Reported By</th>
            <th>Potential Severity</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let data of nearMissTable.data">
            <td>{{ data.incidentDateTime | date:'mediumDate' }}</td>
            <td>{{ data.description }}</td>
            <td>{{ data.location }}</td>
            <td>{{ data.anonymous ? 'Anonymous' : getReporterName(data.reportedBy) }}</td>
            <td><nz-tag [nzColor]="getSeverityColor(data.potentialSeverity)">{{ data.potentialSeverity }}</nz-tag></td>
            <td><nz-tag [nzColor]="getStatusColor(data.status)">{{ data.status }}</nz-tag></td>
            <td>
              <a [routerLink]="['../near-misses/view', data.id]">View</a>
            </td>
          </tr>
        </tbody>
      </nz-table>

      <nz-table *ngIf="activeTab() === 'medical'" #medicalTable [nzData]="medicalSurveillances()" [nzPageSize]="8">
        <thead>
          <tr>
            <th>Exam Date</th>
            <th>Employee</th>
            <th>Type</th>
            <th>Fitness Status</th>
            <th>Reported By</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let data of medicalTable.data">
            <td>{{ data.examinationDate | date:'mediumDate' }}</td>
            <td>{{ getEmployeeLabel(data.employee) }}</td>
            <td>{{ data.examinationType }}</td>
            <td>
              <nz-tag [nzColor]="data.fitnessStatus ? 'green' : 'red'">
                {{ data.fitnessStatus ? 'Fit' : 'Not Fit' }}
              </nz-tag>
            </td>
            <td>{{ getReporterName(data.reportedBy) }}</td>
            <td><nz-tag [nzColor]="getStatusColor(data.status)">{{ data.status }}</nz-tag></td>
            <td>
              <a [routerLink]="['../medical/view', data.id]">View</a>
            </td>
          </tr>
        </tbody>
      </nz-table>
    </nz-card>
  </div>
</div>
